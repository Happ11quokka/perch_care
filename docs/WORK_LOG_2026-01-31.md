# 작업 일지 — 2026-01-31

> 총 변경: **28개 파일**, +1,296 / -540 lines
> 신규 파일: 11개 | 수정 파일: 17개

---

## 1. 비밀번호 재설정 기능 (Backend + Flutter)

### Backend

| 파일 | 변경 내용 |
|------|-----------|
| `backend/app/routers/auth.py` | `POST /reset-password`, `POST /verify-reset-code`, `POST /update-password` 3개 엔드포인트 추가 |
| `backend/app/schemas/auth.py` | `VerifyResetCodeRequest`, `UpdatePasswordRequest` 스키마 추가 |
| `backend/app/services/auth_service.py` | 비밀번호 재설정 로직 구현 — 4자리 인증코드 생성, 인메모리 저장(10분 만료), 코드 검증, 비밀번호 업데이트 |
| `backend/app/utils/email.py` **(신규)** | Gmail SMTP를 통한 비밀번호 재설정 코드 이메일 발송 (HTML 템플릿 포함) |
| `backend/app/config.py` | SMTP 설정 추가 (`smtp_host`, `smtp_port`, `smtp_user`, `smtp_password`) |
| `backend/.env` / `.env.example` | SMTP 환경변수 추가 |
| `backend/docker-compose.yml` | SMTP 환경변수 전달, `--reload` 옵션 추가, 소스코드 볼륨 마운트(`:ro`) 추가 |

### Flutter

| 파일 | 변경 내용 |
|------|-----------|
| `lib/src/screens/forgot_password/forgot_password_method_screen.dart` | 비밀번호 찾기 방법 선택 화면 리팩토링 |
| `lib/src/screens/forgot_password/forgot_password_reset_screen.dart` | 비밀번호 재설정 화면 수정 |

---

## 2. BHI(Bird Health Index) 서비스 개선

| 파일 | 변경 내용 |
|------|-----------|
| `backend/app/services/bhi_service.py` | **체중 비교 로직 개선**: `_get_weight_near_date()` 함수 추가 — 정확한 날짜에 기록이 없을 경우 ±N일 범위에서 가장 가까운 기록을 탐색. **날짜 폴백 로직 추가**: `_find_latest_record_date()` — 요청 날짜에 데이터가 전혀 없으면 가장 최근 기록 날짜로 자동 폴백. `union_all` 임포트 추가 |

---

## 3. 라우터 구조 변경 — StatefulShellRoute 도입

| 파일 | 변경 내용 |
|------|-----------|
| `lib/src/router/app_router.dart` | 기존 `GoRoute` 기반 홈/체중 라우트를 `StatefulShellRoute.indexedStack`으로 전환. 하단 네비게이션 바와 연동하여 탭 전환 시 상태 유지 |
| `lib/src/widgets/bottom_nav_bar.dart` | `StatefulNavigationShell` 연동을 위한 수정 |

---

## 4. 로컬 이미지 저장 시스템 (SQLite 기반)

### 신규 파일

| 파일 | 설명 |
|------|------|
| `lib/src/services/storage/local_image_storage_service.dart` **(신규)** | SQLite 기반 로컬 이미지 캐시 서비스. `perch_care_images.db`에 이미지를 BLOB으로 저장. 플랫폼별 분기 처리(iOS/Android: sqflite, macOS/Linux/Windows: sqflite_common_ffi) |
| `lib/src/widgets/local_image_avatar.dart` **(신규)** | SQLite에서 이미지를 로드하여 원형 아바타로 표시하는 재사용 위젯 |

### 적용된 화면

| 파일 | 변경 내용 |
|------|-----------|
| `lib/main.dart` | `LocalImageStorageService.instance.init()` 초기화 추가 |
| `lib/src/screens/profile_setup/profile_setup_screen.dart` | 프로필 이미지 로컬 저장 연동 |
| `lib/src/screens/pet/pet_add_screen.dart` | 펫 프로필 이미지 로컬 저장 연동 |
| `lib/src/services/auth/auth_service.dart` | 로그아웃/탈퇴 시 `clearAll()` 호출 추가 |

### 의존성 추가 (`pubspec.yaml`)

- `sqflite: ^2.4.1`
- `sqflite_common_ffi: ^2.3.4+4`
- `path_provider: ^2.1.5`
- `path: ^1.9.0`

---

## 5. ActivePetNotifier 추가

| 파일 | 설명 |
|------|------|
| `lib/src/services/pet/active_pet_notifier.dart` **(신규)** | 활성 펫 변경을 앱 전체에 브로드캐스트하는 `ChangeNotifier` 싱글톤. `PetProfileScreen`에서 선택 → `HomeScreen` 등에서 리로드 |

---

## 6. 화면 UI 개선

| 파일 | 변경 내용 |
|------|-----------|
| `lib/src/screens/home/home_screen.dart` | 홈 화면 대폭 개선 (+169 lines) |
| `lib/src/screens/weight/weight_detail_screen.dart` | 체중 상세 화면 대폭 리팩토링 (+737 lines 변경) |
| `lib/src/screens/weight/weight_record_screen.dart` | 체중 기록 화면 수정 |
| `lib/src/screens/bhi/bhi_detail_screen.dart` | BHI 상세 화면 수정 |
| `lib/src/screens/pet/pet_profile_screen.dart` | 펫 프로필 화면 수정 |
| `lib/src/screens/profile/profile_screen.dart` | 유저 프로필 화면 수정 |
| `lib/src/screens/ai_encyclopedia/ai_encyclopedia_screen.dart` | 소소한 수정 |

---

## 7. 유저 서비스 수정 (Backend)

| 파일 | 변경 내용 |
|------|-----------|
| `backend/app/services/user_service.py` | `update_profile()` — `selectinload(User.social_accounts)` 추가하여 `ProfileResponse` 직렬화 시 N+1 문제 해결 |

---

## 8. 에셋 추가

| 파일 | 설명 |
|------|------|
| `assets/images/back_arrow_icon.svg` | 뒤로가기 아이콘 |
| `assets/images/check_gray_icon.svg` | 체크 아이콘 (회색) |
| `assets/images/eye_off_filled_icon.svg` | 비밀번호 숨기기 아이콘 |
| `assets/images/mail_gray_icon.svg` | 이메일 아이콘 (회색) |
| `assets/images/phone_icon.svg` | 전화 아이콘 |
| `assets/images/b547...svg`, `assets/images/f0ff...svg` | 기타 SVG 에셋 |

---

## 9. 빌드 이슈 해결

### sqflite MissingPluginException

- **증상**: Hot restart 시 `MissingPluginException(No implementation found for method openDatabase on channel com.tekartik.sqflite)` 발생
- **원인**: `sqflite`는 네이티브 플러그인이므로 hot restart로는 네이티브 코드가 반영되지 않음. 의존성 추가 후 전체 빌드가 필요
- **해결**: `flutter clean` → `flutter pub get` → `pod install --repo-update` → 전체 빌드 실행
